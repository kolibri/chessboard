/*!
 * Copyright (c) 2016 Lukas Sadzik <entengelb@gmail.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights 
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is 
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
window.onload=function(){var e=function(e,t,a){for(var n=0;n<e.length;n++)t.call(a,n,e[n])},t=function(e){function t(e){for(y in f)for(x in p){var t=p[x]+f[y],a=e.querySelector("."+t),n=u.get(t);a.classList.remove("wk","wq","wr","wb","wn","wp","bk","bq","br","bb","bn","bp"),n&&n.color&&n.type&&a.classList.add(n.color+n.type)}}function a(e){var t="";return t=0<=e.flags.indexOf("k")?"O-O":0<=e.flags.indexOf("q")?"O-O-O":T[e.piece]+e.from+(0<=e.flags.indexOf("c")||0<=e.flags.indexOf("e")?"x":"-")+e.to+(0<=e.flags.indexOf("e")?"ep":"")+(0<=e.flags.indexOf("p")?e.promotion:""),0<=e.san.indexOf("+")&&(t+="+"),0<=e.san.indexOf("#")&&(t+="#"),t}function d(){board=document.createElement("div"),board.classList.add("board");var e="white";for(y in f){var t=document.createElement("div");t.classList.add("row","r"+f[y]);for(x in p){var a=document.createElement("div"),n=p[x]+f[y];a.classList.add("field",n,e),e="white"==e?"black":"white",t.appendChild(a)}e="white"==e?"black":"white",board.appendChild(t)}return board}function r(){var e=u.header();for(filterName in k){var t=k[filterName],a=e[t];v[t]=a}}function s(){var e=document.createElement("dl");e.classList.add("info");for(headerName in v){var t=document.createElement("dt");t.appendChild(document.createTextNode(headerName));var a=document.createElement("dd");a.appendChild(document.createTextNode(v[headerName])),e.appendChild(t),e.appendChild(a)}return e}function i(e){var n=document.createElement("ol");n.classList.add("moves");for(m in B){if("w"==B[m].color){var d=document.createElement("li");n.appendChild(d)}var r=document.createElement("span");r.dataset.move=m,r.addEventListener("click",function(){l(parseInt(this.dataset.move)+1),t(e)}),H-1==r.dataset.move&&r.classList.add("current"),r.appendChild(document.createTextNode(a(B[m]))),d.appendChild(r)}return n}function o(e){function a(e,t){var a=document.createElement("button");a.appendChild(document.createTextNode(e)),a.addEventListener("click",t),n.appendChild(a)}var n=document.createElement("div");return n.classList.add("buttons"),a(E,function(){u.reset(),t(e),H=0}),a(g,function(){!H>0||(u.undo(),H-=1,t(e))}),a(N,function(){l(H+1),t(e)}),a(O,function(){C=!C,f.reverse(),p.reverse(),c()}),n}function l(e){if(!(e>B.length)){for(u.reset(),n=0;n<e;n++)u.move(B[n]);H=e}}function c(){e.innerHTML="",1==b&&e.appendChild(s()),l(H);var a=d();t(a),e.appendChild(a),1==w&&e.appendChild(o(a)),1==h&&e.appendChild(i(a))}var u=new Chess,p=["a","b","c","d","e","f","g","h"],f=[8,7,6,5,4,3,2,1],v={},h=!e.dataset.showMoves||"true"===e.dataset.showMoves,b=!e.dataset.showHeader||"true"===e.dataset.showHeader,w=!e.dataset.showButtons||"true"===e.dataset.showButtons,C=!!e.dataset.reversed&&"true"===e.dataset.reversed,N=e.dataset.labelNext?e.dataset.labelNext:"next",g=e.dataset.labelBack?e.dataset.labelBack:"back",E=e.dataset.labelReset?e.dataset.labelReset:"reset",O=e.dataset.labelTurn?e.dataset.labelTurn:"turn",L=!!e.dataset.ply&&parseInt(e.dataset.ply),k=e.dataset.displayHeaders?e.dataset.displayHeaders.split(","):["White","Black","Date","Event","Result"],T=e.dataset.pieceNames?JSON.parse(e.dataset.pieceNames):{k:"K",q:"Q",b:"B",n:"N",r:"R",p:""},q=e.innerHTML.trim().replace(/^\s+/gm,"");if(u.load_pgn(q)){C&&(f.reverse(),p.reverse());var B=u.history({verbose:!0}),H=!1!==L?L:B.length;this.init=function(){r(),c()}}};e(document.querySelectorAll(".pgn"),function(e,a){board=new t(a),board.init()})};