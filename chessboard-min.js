/*!
 * Copyright (c) 2016 Lukas Sadzik <entengelb@gmail.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights 
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is 
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
document.addEventListener("DOMContentLoaded",function(){var e=function(e){function t(e){for(var t in f)for(var a in p){var n=p[a]+f[t],d=e.querySelector("."+n),r=u.get(n);d.classList.remove("wk","wq","wr","wb","wn","wp","bk","bq","br","bb","bn","bp"),r&&r.color&&r.type&&d.classList.add(r.color+r.type)}}function a(e){var t="";return t=0<=e.flags.indexOf("k")?"O-O":0<=e.flags.indexOf("q")?"O-O-O":y[e.piece]+e.from+(0<=e.flags.indexOf("c")||0<=e.flags.indexOf("e")?"x":"-")+e.to+(0<=e.flags.indexOf("e")?"ep":"")+(0<=e.flags.indexOf("p")?e.promotion:""),0<=e.san.indexOf("+")&&(t+="+"),0<=e.san.indexOf("#")&&(t+="#"),t}function d(){var e=document.createElement("div");e.classList.add("board");var t="white";for(var a in f){var n=document.createElement("div");n.classList.add("row","r"+f[a]);for(x in p){var d=document.createElement("div"),r=p[x]+f[a];d.classList.add("field",r,t),t="white"===t?"black":"white",n.appendChild(d)}t="white"===t?"black":"white",e.appendChild(n)}return e}function r(){var e=u.header();for(filterName in k){var t=k[filterName],a=e[t];v[t]=a}}function s(){var e=document.createElement("dl");e.classList.add("info");for(headerName in v){var t=document.createElement("dt");t.appendChild(document.createTextNode(headerName));var a=document.createElement("dd");a.appendChild(document.createTextNode(v[headerName])),e.appendChild(t),e.appendChild(a)}return e}function i(e){var n=document.createElement("ol");n.classList.add("moves");for(m in q){if("w"===q[m].color){var d=document.createElement("li");n.appendChild(d)}var r=document.createElement("span");r.dataset.move=m,r.addEventListener("click",function(){l(parseInt(this.dataset.move)+1),t(e)}),H-1===r.dataset.move&&r.classList.add("current"),r.appendChild(document.createTextNode(a(q[m]))),d.appendChild(r)}return n}function o(e){function a(e,t){var a=document.createElement("button");a.appendChild(document.createTextNode(e)),a.addEventListener("click",t),n.appendChild(a)}var n=document.createElement("div");return n.classList.add("buttons"),a(g,function(){u.reset(),t(e),H=0}),a(N,function(){!H>0||(u.undo(),H-=1,t(e))}),a(E,function(){l(H+1),t(e)}),a(L,function(){C=!C,f.reverse(),p.reverse(),c()}),n}function l(e){if(!(e>q.length)){for(u.reset(),n=0;n<e;n++)u.move(q[n]);H=e}}function c(){e.style.display="none",T.classList.add("pgn-board"),!0===b&&T.appendChild(s()),l(H);var a=d();t(a),T.appendChild(a),!0===w&&T.appendChild(o(a)),!0===h&&T.appendChild(i(a))}var u=new Chess,p=["a","b","c","d","e","f","g","h"],f=[8,7,6,5,4,3,2,1],v={},h=!e.dataset.showMoves||"true"===e.dataset.showMoves,b=!e.dataset.showHeader||"true"===e.dataset.showHeader,w=!e.dataset.showButtons||"true"===e.dataset.showButtons,C=!!e.dataset.reversed&&"true"===e.dataset.reversed,E=e.dataset.labelNext?e.dataset.labelNext:"next",N=e.dataset.labelBack?e.dataset.labelBack:"back",g=e.dataset.labelReset?e.dataset.labelReset:"reset",L=e.dataset.labelTurn?e.dataset.labelTurn:"turn",O=!!e.dataset.ply&&parseInt(e.dataset.ply),k=e.dataset.displayHeaders?e.dataset.displayHeaders.split(","):["White","Black","Date","Event","Result"],y=e.dataset.pieceNames?JSON.parse(e.dataset.pieceNames):{k:"K",q:"Q",b:"B",n:"N",r:"R",p:""},B=e.innerHTML.trim().replace(/^\s+/gm,"");if(u.load_pgn(B)){var T=document.createElement("div");e.parentNode.insertBefore(T,e),C&&(f.reverse(),p.reverse());var q=u.history({verbose:!0}),H=!1!==O?O:q.length;this.init=function(){r(),c()}}};!function(e,t,a){for(var n=0;n<e.length;n++)t.call(a,n,e[n])}(document.querySelectorAll(".pgn"),function(t,a){board=new e(a),board.init()})});